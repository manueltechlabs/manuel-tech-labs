---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import Button from '@/components/base/button.astro';
import HeadingBlock from '@/components/layout/heading-block.astro';
import Pagination from '@/components/layout/pagination.astro';

import Projects from '@/components/project/projects.astro';

import { siteConfig } from '@/app/config/site';
import BaseLayout from '@/app/layouts/base-layout.astro';
import FeaturedProjects from '@/components/project/featured-projects.astro';

const allProjects = await getCollection('projects', ({ data }) => !data.isDraft);

const sortedProjects = allProjects.sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Featured projects
// Filter projects that have the 'featured_at' field defined in their frontmatter
const featuredProjectsList = allProjects.filter(project => project.data.featuredAt);

// Sort the filtered projects by the featured date (newest first)
featuredProjectsList.sort((a, b) => new Date(b.data.featuredAt).getTime() - new Date(a.data.featuredAt).getTime());

// Slice the list to get only the top 3
const myFeaturedProjects = featuredProjectsList.slice(0, 3);

const numberOfPages = Math.ceil(sortedProjects.length / siteConfig.postsPerPage);

export const getStaticPaths = (async ({ paginate }) => {
  // data
  const allProjects = await getCollection('projects', ({ data }) => !data.isDraft);
  return paginate(
    allProjects.sort((a, b) => {
      return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
    }),
    {
      pageSize: siteConfig.postsPerPage,
    }
  );
}) satisfies GetStaticPaths;

const { page } = Astro.props;

const title =
  page.currentPage === 1 ? siteConfig.title : siteConfig.title + ' ' + 'Page ' + page.currentPage;


---


<BaseLayout title={title}>
  <main class='main'>
    <HeadingBlock title="Spring-Powered Solutions"
    descriptionItems={["A showcase of backend systems and full-stack applications built with Spring Bootâ€”demonstrating clean architecture, integration with databases and cloud services, and a focus on solving complex operational challenges in supply chain and beyond."]} />
    <HeadingBlock title="Pinned Projects"
    />
    {
      page.currentPage === 1 && <FeaturedProjects projects={myFeaturedProjects}/>
    }
    <HeadingBlock title="Projects"
    />
    {
      <Projects projects={page.data} />
    }
    {
      numberOfPages > 1 && (
        <Pagination
          currentPage={page.currentPage}
          numPages={numberOfPages}
          slug='/projects/'
        />
      )
    }
  </main>
</BaseLayout>
